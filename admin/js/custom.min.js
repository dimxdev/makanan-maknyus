$(function() {
    "use strict";
    // Preloader fade out
    $(".preloader").fadeOut();

    // Prevent mega-dropdown from closing
    $(document).on("click", ".mega-dropdown", function(e) {
        e.stopPropagation();
    });

    // Adjust sidebar and page height on resize
    var adjustLayout = function() {
        var body = $("body");
        var navbarBrand = $(".navbar-brand span");
        var pageWrapper = $(".page-wrapper");
        var windowWidth = window.innerWidth || this.screen.width;
        var windowHeight = window.innerHeight || this.screen.height;
        
        if (windowWidth < 1170) {
            body.addClass("mini-sidebar");
            navbarBrand.hide();
            $(".scroll-sidebar, .slimScrollDiv").css("overflow-x", "visible").parent().css("overflow", "visible");
            $(".sidebartoggler i").addClass("ti-menu");
        } else {
            body.removeClass("mini-sidebar");
            navbarBrand.show();
        }
        
        var minHeight = Math.max(1, windowHeight - 71);
        pageWrapper.css("min-height", minHeight + "px");
    };

    // Initialize on load and resize
    $(window).on("resize load", adjustLayout);

    // Toggle sidebar
    $(".sidebartoggler").on("click", function() {
        var body = $("body");
        var navbarBrand = $(".navbar-brand span");
        var isMiniSidebar = body.hasClass("mini-sidebar");

        body.toggleClass("mini-sidebar", !isMiniSidebar);
        navbarBrand.toggle(!isMiniSidebar);
        $(".scroll-sidebar, .slimScrollDiv").css("overflow-x", isMiniSidebar ? "visible" : "hidden").parent().css("overflow", "visible");
        $(body).trigger("resize");
    });

    // Sticky header
    $(".fix-header .header").stick_in_parent();

    // Sidebar toggle
    $(".nav-toggler").click(function() {
        $("body").toggleClass("show-sidebar");
        $(".nav-toggler i").toggleClass("mdi mdi-menu mdi-close");
    });

    // Toggle search box
    $(".search-box a, .search-box .app-search .srh-btn").click(function() {
        $(".app-search").slideToggle(200);
    });

    // Floating labels focus and blur
    $(".floating-labels .form-control").on("focus blur", function(e) {
        $(this).parents(".form-group").toggleClass("focused", e.type === "focus" || this.value.length > 0);
    }).trigger("blur");

    // Highlight active sidebar link
    var currentUrl = window.location.href;
    $("ul#sidebarnav a").filter(function() {
        return this.href === currentUrl;
    }).addClass("active").parent().addClass("active").parents("li").addClass("in active");

    // Initialize MetisMenu for sidebar
    $("#sidebarnav").metisMenu();

    // SlimScroll initialization
    $(".scroll-sidebar, .message-center, .aboutscroll, .message-scroll, .chat-box, .slimscrollright").slimScroll({
        position: "left", size: "5px", color: "#dcdcdc", height: "100%"
    });

    // Task label toggle
    $(".list-task li label").click(function() {
        $(this).toggleClass("task-done");
    });

    // Toggle login/recover form
    $("#to-recover").click(function() {
        $("#loginform").slideUp();
        $("#recoverform").fadeIn();
    });

    // Card collapse, expand, close actions
    $('a[data-action="collapse"]').click(function(e) {
        e.preventDefault();
        var card = $(this).closest(".card");
        card.find('[data-action="collapse"] i').toggleClass("ti-minus ti-plus");
        card.children(".card-body").collapse("toggle");
    });

    $('a[data-action="expand"]').click(function(e) {
        e.preventDefault();
        var card = $(this).closest(".card");
        card.find('[data-action="expand"] i').toggleClass("mdi-arrow-expand mdi-arrow-compress");
        card.toggleClass("card-fullscreen");
    });

    $('a[data-action="close"]').click(function() {
        $(this).closest(".card").removeClass().slideUp("fast");
    });
});
